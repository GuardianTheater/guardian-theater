<div class="activity">
  <div *ngIf="!pgcr && activity" class="columns small-12" (click)="toActivity(activity.activityDetails.instanceId)">

    <div class="row">
      <div class="mode columns small-12 mode-no-clips">
        <span>Fetching PGCR from Bungie...</span>
      </div>
    </div>
    <div class="row info-row">
      <div class="columns small-4">
        <div class="row">
          <div class="mode columns small-12 mode-no-clips date-block">
            <span></span>
          </div>
        </div>
        <div class="row">
          <div class="columns small-6 spinner-block mode-no-clips">
            <div class="player-spinner">
              <span class="fi-widget spinner bungie-spinner" title="Fetching data from Bungie..."></span>
            </div>
          </div>
          <div class="columns small-6 spinner-block mode-no-clips">
            0
          </div>
        </div>
      </div>
    </div>
  </div>
    
  <div *ngIf="pgcr" class="columns small-12">
    <div class="row" (click)="toActivity(pgcr.activityDetails.instanceId)">
      <div class="mode columns activity-title-bar small-12" [ngClass]="(pgcr.filteredClips$ | async).length ? 'mode-' + pgcr.activityDetails.mode : 'mode-no-clips'">
        <span class="activity-name">{{ pgcr.loading.message || (pgcr.activityDetails.mode | activityMode) + ': ' + (pgcr.activityDetails.referenceId | activityName) }}</span>
        <a class="activity-link bungie" title="View Activity on Bungie" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).activity.bungie" [href]="'https://www.bungie.net/en/Legend/PGCR?instanceId=' + pgcr.activityDetails.instanceId" target="_blank"></a>
        <a class="activity-link tracker" title="View Activity on Destiny Tracker" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).activity.tracker" [href]="'http://destinytracker.com/dg/' + pgcr.activityDetails.instanceId" target="_blank"></a>
        <a class="activity-link ggg" title="View Activity on Guardian.gg" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).activity.ggg" [href]="'http://guardian.gg/en/pgcr/' + pgcr.activityDetails.instanceId" target="_blank"></a>
        <a class="profile-link trials" [ngClass]="pgcr.teams[0].teamName" title="View Alpha Team on Trials Report" (click)="stopPropagation($event)" *ngIf="pgcr.teams && pgcr.teams[0] && pgcr.teams[0].entries && pgcr.activityDetails.mode === 14 && (settingsService.links | async).activity.trials" [href]="'https://trials.report/' + (membershipType === 1 ? 'xbox' : 'ps') + '/' + pgcr.teams[0].entries[0].player.destinyUserInfo.displayName + '/' + pgcr.teams[0].entries[1].player.destinyUserInfo.displayName + '/' + pgcr.teams[0].entries[2].player.destinyUserInfo.displayName" target="_blank"></a>
        <a class="profile-link trials" [ngClass]="pgcr.teams[1].teamName" title="View Bravo Team on Trials Report" (click)="stopPropagation($event)" *ngIf="pgcr.teams && pgcr.teams[0] && pgcr.teams[0].entries && pgcr.activityDetails.mode === 14 && (settingsService.links | async).activity.trials" [href]="'https://trials.report/' + (membershipType === 1 ? 'xbox' : 'ps') + '/' + pgcr.teams[1].entries[0].player.destinyUserInfo.displayName + '/' + pgcr.teams[1].entries[1].player.destinyUserInfo.displayName + '/' + pgcr.teams[1].entries[2].player.destinyUserInfo.displayName" target="_blank"></a>
      </div>
    </div>
    <div class="row info-row">
      <div class="columns small-4" (click)="toActivity(pgcr.activityDetails.instanceId)">
        <div class="row">
          <div class="mode columns small-12 date-block" [ngClass]="(pgcr.filteredClips$ | async).length ? 'mode-' + pgcr.activityDetails.mode : 'mode-no-clips'">
            <span class="activity-time">{{ pgcr.period | date:'medium' }}</span>
          </div>
        </div>
        <div class="row">
          <div class="columns small-6 spinner-block" [ngClass]="(pgcr.filteredClips$ | async).length ? 'mode-' + pgcr.activityDetails.mode : 'mode-no-clips'">
            <div class="player-spinner" *ngIf="pgcr.loading && (pgcr.loading.twitch || pgcr.loading.bungie || pgcr.loading.xbox)">
              <span class="fi-widget spinner bungie-spinner" title="Fetching data from Bungie..."
                *ngIf="true || pgcr.loading.bungie"
                [ngClass]="{
                  'half-spinner-a': pgcr.loading.twitch || pgcr.loading.xbox,
                  'third-spinner-a': pgcr.loading.twitch && pgcr.loading.xbox
                }"></span>
              <span class="fi-widget spinner twitch-spinner" title="Fetching data from Twitch..."
                *ngIf="pgcr.loading.twitch"
                [ngClass]="{
                  'half-spinner-b': pgcr.loading.bungie,
                  'half-spinner-a': pgcr.loading.xbox,
                  'third-spinner-b': pgcr.loading.bungie && pgcr.loading.xbox
                }"></span>
              <span class="fi-widget spinner xbox-spinner" title="Fetching data from Xbox..."
                *ngIf="pgcr.loading.xbox"
                [ngClass]="{
                  'half-spinner-b': pgcr.loading.twitch || pgcr.loading.bungie,
                  'third-spinner-c': pgcr.loading.twitch && pgcr.loading.bungie
                }"></span>
            </div>

            <div *ngIf="pgcr.loading && !pgcr.loading.twitch && !pgcr.loading.bungie && !pgcr.loading.xbox">
              <span class="fi-video" *ngIf="pgcr.clips && pgcr.clips.length"></span>
              <span class="fi-x" *ngIf="!pgcr.clips || !pgcr.clips.length"></span>
            </div>
          </div>

          <div class="columns small-6 spinner-block" [ngClass]="(pgcr.filteredClips$ | async).length ? 'mode-' + pgcr.activityDetails.mode : 'mode-no-clips'">
            {{ (pgcr.clips$ | async).length }}
          </div>
        </div>
      </div>

      <span class="columns small-8 pgcr pgcr-full pgcr-no-teams" *ngIf="!pgcr.teams || !pgcr.teams.length" [ngClass]="(pgcr.filteredClips$ | async).length ? '' : 'no-clips'">
        <div class="row">
          <div (click)="toGuardian(entry.player.destinyUserInfo.displayName, entry.characterId)" class="columns small-6 mode pgcr-entry" *ngFor="let entry of pgcr.entries" [ngClass]="{
            'Opponent': pgcr.active.entry && (pgcr.activityDetails.mode === 13 || pgcr.activityDetails.mode === 27 || pgcr.activityDetails.mode === 29 || pgcr.activityDetails.mode === 33),
            'Team': pgcr.active.entry && pgcr.activityDetails.mode !== 13 && pgcr.activityDetails.mode !== 27 && pgcr.activityDetails.mode !== 29 && pgcr.activityDetails.mode !== 33,
            'Fireteam': pgcr.active && pgcr.active.fireteam && entry.extended && entry.extended.values.fireTeamId && pgcr.active.fireteam === entry.extended.values.fireTeamId.basic.value,
            'Player': pgcr.active && pgcr.active.entry && pgcr.active.entry.characterId === entry.characterId
          }">
            <span class="pgcr-entry-name">{{ entry.player.destinyUserInfo.displayName }}</span>
            <a class="profile-link twitch" title="View Guardian on Twitch" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.twitch && entry.player.bungieNetUserInfo && (twitchService.twitch[entry.player.bungieNetUserInfo.membershipId] | async).twitchId" [href]="'https://www.twitch.tv/' + (twitchService.twitch[entry.player.bungieNetUserInfo.membershipId] | async).twitchId" target="_blank"></a>
            <a class="profile-link bungie" title="View Guardian on Bungie" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.bungie" [href]="'https://www.bungie.net/en/Stats/' + entry.player.destinyUserInfo.membershipType  + '/' + entry.player.destinyUserInfo.membershipId  + '/' + entry.characterId" target="_blank"></a>
            <a class="profile-link tracker" title="View Guardian on Destiny Tracker" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.tracker" [href]="'http://destinytracker.com/destiny/overview/' + (entry.player.destinyUserInfo.membershipType === 1 ? 'xbox' : 'ps') + '/' + entry.player.destinyUserInfo.displayName" target="_blank"></a>
            <a class="profile-link ggg" title="View Guardian on Guardian.gg" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.ggg" [href]="'http://guardian.gg/en/profile/' + entry.player.destinyUserInfo.membershipType  + '/' + entry.player.destinyUserInfo.displayName" target="_blank"></a>
          </div>
        </div>
      </span>

      <span class="columns small-4 pgcr pgcr-full pgcr-teams" *ngFor="let team of pgcr.teams" [ngClass]="(pgcr.filteredClips$ | async).length ? '' : 'no-clips'">
        <div class="row">
          <div (click)="toGuardian(entry.player.destinyUserInfo.displayName, entry.characterId)" class="columns small-12 mode pgcr-entry" *ngFor="let entry of team.entries" [ngClass]="{
            'Alpha': team.teamName === 'Alpha',
            'Bravo': team.teamName === 'Bravo',
            'Team': pgcr.active && pgcr.active.team > -1 && entry.values.team && pgcr.active.team === entry.values.team.basic.value,
            'Opponent': pgcr.active && pgcr.active.team > -1 && entry.values.team && pgcr.active.team !== entry.values.team.basic.value,
            'Fireteam': pgcr.active && pgcr.active.fireteam && entry.extended && entry.extended.values.fireTeamId && pgcr.active.fireteam === entry.extended.values.fireTeamId.basic.value,
            'Player': pgcr.active && pgcr.active.entry && pgcr.active.entry.characterId === entry.characterId
          }">
            <span class="pgcr-entry-name">{{ entry.player.destinyUserInfo.displayName }}</span>
            <a class="profile-link twitch" title="View Guardian on Twitch" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.twitch && entry.player.bungieNetUserInfo && (twitchService.twitch[entry.player.bungieNetUserInfo.membershipId] | async).twitchId" [href]="'https://www.twitch.tv/' + (twitchService.twitch[entry.player.bungieNetUserInfo.membershipId] | async).twitchId" target="_blank"></a>
            <a class="profile-link bungie" title="View Guardian on Bungie" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.bungie" [href]="'https://www.bungie.net/en/Stats/' + entry.player.destinyUserInfo.membershipType  + '/' + entry.player.destinyUserInfo.membershipId  + '/' + entry.characterId" target="_blank"></a>
            <a class="profile-link tracker" title="View Guardian on Destiny Tracker" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.tracker" [href]="'http://destinytracker.com/destiny/overview/' + (entry.player.destinyUserInfo.membershipType === 1 ? 'xbox' : 'ps') + '/' + entry.player.destinyUserInfo.displayName" target="_blank"></a>
            <a class="profile-link ggg" title="View Guardian on Guardian.gg" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.ggg" [href]="'http://guardian.gg/en/profile/' + entry.player.destinyUserInfo.membershipType  + '/' + entry.player.destinyUserInfo.displayName" target="_blank"></a>
          </div>
        </div>
      </span>
    </div>
  </div>

  <div *ngIf="pgcr" class="columns small-12 clips">
    <div *ngFor="let clip of (pgcr.filteredClips$ | async)" class="clip-item">
      <div class="row">
        <div (click)="toGuardian(clip.entry.player.destinyUserInfo.displayName, clip.entry.characterId)" class="columns small-12 mode pgcr-entry" [ngClass]="{
          'Alpha': clip.entry.values.team && clip.entry.values.team.basic.displayValue === 'Alpha',
          'Bravo': clip.entry.values.team && clip.entry.values.team.basic.displayValue === 'Bravo',
          'Team': (pgcr.active && pgcr.active.team > -1 && clip.entry.values.team && pgcr.active.team === clip.entry.values.team.basic.value) || (pgcr.active.entry && !pgcr.teams.length && pgcr.activityDetails.mode !== 13 && pgcr.activityDetails.mode !== 27 && pgcr.activityDetails.mode !== 29 && pgcr.activityDetails.mode !== 33),
          'Opponent': (pgcr.active && pgcr.active.team > -1 && clip.entry.values.team && pgcr.active.team !== clip.entry.values.team.basic.value) || (pgcr.active.entry && !pgcr.teams.length && pgcr.activityDetails.mode === 13 || pgcr.activityDetails.mode === 27 || pgcr.activityDetails.mode === 29 || pgcr.activityDetails.mode === 33),
          'Fireteam': pgcr.active && pgcr.active.fireteam && clip.entry.extended && clip.entry.extended.values.fireTeamId && pgcr.active.fireteam === clip.entry.extended.values.fireTeamId.basic.value,
          'Player': pgcr.active && pgcr.active.entry && pgcr.active.entry.characterId === clip.entry.characterId
        }">
          <span class="pgcr-entry-name">{{ clip.entry.player.destinyUserInfo.displayName }}</span>
          <a class="profile-link twitch" title="View Guardian on Twitch" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.twitch && clip.entry.player.bungieNetUserInfo && (twitchService.twitch[clip.entry.player.bungieNetUserInfo.membershipId] | async).twitchId" [href]="'https://www.twitch.tv/' + (twitchService.twitch[clip.entry.player.bungieNetUserInfo.membershipId] | async).twitchId" target="_blank"></a>
          <a class="profile-link bungie" title="View Guardian on Bungie" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.bungie" [href]="'https://www.bungie.net/en/Stats/' + clip.entry.player.destinyUserInfo.membershipType  + '/' + clip.entry.player.destinyUserInfo.membershipId  + '/' + clip.entry.characterId" target="_blank"></a>
          <a class="profile-link tracker" title="View Guardian on Destiny Tracker" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.tracker" [href]="'http://destinytracker.com/destiny/overview/' + (clip.entry.player.destinyUserInfo.membershipType === 1 ? 'xbox' : 'ps') + '/' + clip.entry.player.destinyUserInfo.displayName" target="_blank"></a>
          <a class="profile-link ggg" title="View Guardian on Guardian.gg" (click)="stopPropagation($event)" *ngIf="(settingsService.links | async).guardian.ggg" [href]="'http://guardian.gg/en/profile/' + clip.entry.player.destinyUserInfo.membershipType  + '/' + clip.entry.player.destinyUserInfo.displayName" target="_blank"></a>
        </div>
      </div>
      <div class="row" *ngIf="clip.type === 'twitch'">
        <a class="columns small-12 mode twitch-banner" target="_blank" [href]="clip.video.url">
          <span class="twitch-clip-name">{{ clip.video.title }}</span>
          <span class="twitch-timestamp">{{ clip.start | twitchStamp:clip.entry.startTime }}</span>
        </a>
        <div class="columns small-12 clip-wrapper" *ngIf="!clip.play">
          <img class="clip-thumbnail" (click)="clip.play = !clip.play" [src]="clip.video.thumbnails[0].url">
        </div>
        <div class="columns small-12 clip-wrapper" *ngIf="clip.play">
          <iframe
            class="twitch-embed"
            [src]="clip.embedUrl"
            frameborder="0"
            scrolling="no"
            allowfullscreen="true">
          </iframe>
        </div>
      </div>
      <div class="row" *ngIf="clip.type === 'xbox'">
        <div class="columns small-12 clip-wrapper">
          <video id="my-video" class="video-js twitch-embed" controls preload="none" [poster]="clip.video.thumbnails[0].uri" data-setup="{}">
            <source [src]="clip.video.gameClipUris[0].uri" type="video/mp4">
          </video>
        </div>
      </div>
    </div>  
  </div>
  
</div>

